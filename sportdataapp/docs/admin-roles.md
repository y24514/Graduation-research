# 管理者 / スーパー管理者 できること一覧

このドキュメントは、Sports Analytics App における **管理者（admin）** と **スーパー管理者（super admin）** の権限差を、実装に合わせて整理したものです。

- 判定は原則としてセッションの `$_SESSION['is_admin']` / `$_SESSION['is_super_admin']` を参照します。
- 永続状態は `login_tbl.is_admin` / `login_tbl.is_super_admin` に保存されます。

## 前提（ロールの定義）

| ロール | 条件（概念） | 主な目的 |
|---|---|---|
| 一般ユーザー | `is_admin=0` かつ `is_super_admin=0` | 記録・日記・チャット等を利用 |
| 管理者 | `is_admin=1` かつ `is_super_admin=0` | メンバーの閲覧、提出された日記の確認、共有予定作成など |
| スーパー管理者 | `is_super_admin=1` | 申請の受理（管理者付与）、お問い合わせ対応 |

## 機能×権限（ざっくり一覧）

| 機能 | 一般 | 管理者 | スーパー管理者 |
|---|---:|---:|---:|
| 管理画面に入れる（admin.php） | × | ○ | ○ |
| 管理者権限の付与/解除（他ユーザーの is_admin 切替） | × | × | ○ |
| 管理者権限申請（pending）の閲覧・承認/却下 | × | × | ○ |
| お問い合わせ一覧の閲覧・返信 | × | × | ○ |
| 提出された日記の一覧を見る（同一group） | × | ○ | ※（設計上、管理画面は別UI） |
| 提出された日記へフィードバックを書く | × | ○ | ○（API判定上は可能） |
| 共有カレンダー予定を作成（is_shared=1） | × | ○ | ○ |
| 「記録」系メニュー（水泳/バスケ/テニス）をナビに出す | ○ | × | × |
| 管理者以外のページにアクセス | ○ | ○ | ×（基本は管理画面へ誘導） |

> 注: 「スーパー管理者は管理画面以外へ行けない」制限があるため、機能的に可能でもUI導線が無いものがあります。

## 詳細（根拠と補足）

### 1) 管理画面（admin.php）

- 管理画面は `is_admin` または `is_super_admin` が必要です。
- スーパー管理者は管理画面で以下のみを扱う設計です。
  - 管理者権限申請の承認/却下
  - お問い合わせの返信
- 管理者は管理画面で以下を扱う設計です。
  - 同一groupのメンバーのデータ閲覧（※管理者・スーパー管理者は閲覧対象から除外）
  - 日記の提出通知の確認
  - カレンダー共有予定の作成

### 2) 管理者権限の申請フロー

- 新規登録時に「管理者権限希望（申請）」を ON にすると、`admin_role_requests` に pending が作成されます（テーブルが存在する場合）。
- スーパー管理者が pending を承認すると、対象ユーザーの `login_tbl.is_admin = 1` を更新し、申請を approved にします。

### 3) 日記（提出・フィードバック）

- 日記の「管理者へ提出」は一般ユーザーのみの設計です（管理者/スーパー管理者は提出できない）。
- 管理者（とスーパー管理者）は、提出された日記に対してフィードバックを書けます。
- これらは DB に提出/フィードバック用の列がある場合のみ機能します。

### 4) カレンダー共有（is_shared）

- 共有予定は管理者のみ作成可能で、保存側で `is_shared` が強制的に落ちるようになっています（一般ユーザーは `is_shared=1` にできない）。
- DB が未更新の場合は共有を拒否します（is_shared列が無い場合）。

### 5) ナビの制限（ヘッダ）

- 管理者（is_admin=1, is_super_admin=0）は「記録」系メニューを非表示にする設計です（閲覧ロール想定）。
- スーパー管理者は、許可ページ以外は管理画面へリダイレクトする設計です。

## DB更新（必要になりがちなSQL）

- 管理者フラグ追加: `db/add_admin_flag.sql`
- スーパー管理者フラグ追加: `db/add_super_admin_flag.sql`
- 管理者権限申請テーブル: `db/add_admin_role_requests.sql`
- お問い合わせテーブル: `db/add_inquiries_tbl.sql`
- カレンダー共有（is_shared）: `db/add_calendar_shared_events.sql`
- テニスDB統合（tennis_db → sportdata_db へ追記）: `db/migrate_tennis_db_into_sportdata_db.sql`

---

更新日: 2026-01-20
